{% extends 'base.html' %}
{% block title %} Login {% endblock %}
{% block content %}
<style>
  body {
    background: #fbcfa2;
    min-height: 100vh;
  }

  .login-card {
    background: #fff;
    border-radius: 12px;
    padding: 2rem;
    max-width: 420px;
    width: 100%;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
  }

  .aprycot-logo img {
    max-width: 160px;
    margin-bottom: 1rem;
  }

  .btn-signin {
    width: 100%;
    background: #ef8827dc;
    border: none;
    color: #fff;
    padding: 0.75rem;
    border-radius: 8px;
    font-weight: 600;
    transition: 0.3s;
  }

  .btn-signin:hover {
    background: #e76f0b;
  }

  .social-icons {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-top: 1rem;
  }

  .social-icon img {
    cursor: pointer;
    transition: transform 0.2s;
  }

  .social-icon img:hover {
    transform: scale(1.1);
  }

  .toggle-password {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    cursor: pointer;
  }

  label {
    font-size: 0.95rem;
    font-weight: 500;
    display: block;
    margin-bottom: 0px;
    color: #7c512c;
  }

  input[type="email"],
  input[type="password"],
  input[type="text"] {
    width: 100%;
    padding: 10px;
    margin-bottom: 12px;
    border-radius: 7px;
    border: 1px solid #dedede;
    background: #f4f7fa;
    font-size: 1rem;
    transition: border-color .2s;
    outline: none;
  }

  input[type="email"]:focus,
  input[type="password"]:focus,
  input[type="text"]:focus {
    border: 1.5px solid #fa820e;
    outline: none;
  }
</style>

<div class="login-card mt-3 mb-5" style="margin: 0 auto;">
  <h4 class="text-center">Sign In</h4>
  <p class="text-muted text-center">Access your Aprycot account</p>

  <form id="loginForm">
    <!-- Email -->
    <div class="form-row">
      <input type="email" id="email" name="email" placeholder="Email" required>
    </div>

    <!-- Password -->
    <div class="form-row position-relative">
      <input type="password" id="password" name="password" placeholder="Password" required>
      <button type="button" class="toggle-password" id="togglePassword">
        <i class="fa fa-eye"></i>
      </button>
    </div>

    <!-- Captcha -->
    <div class="mb-2">
      <label class="form-label"><b>Captcha:</b> <span id="captcha-text">{{ captcha_text }}</span></label>
      <div class="d-flex gap-2">
        <input type="text" id="captcha" name="captcha" placeholder="Enter captcha" required>
        <button type="button" id="refreshBtn" class="btn btn-outline-secondary" style="height:44px">↺</button>
      </div>
    </div>

    <!-- Remember & Forgot -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="form-check">
        <input type="checkbox" id="remember" class="form-check-input">
        <label for="remember" class="form-check-label">Remember me</label>
      </div>
      <a href="{{ url_for('auth.forgot_password') }}" class="text-decoration-none">Forgot Password?</a>

    </div>

    <!-- Sign in -->
    <button class="btn-signin" type="submit">Sign in</button>
  </form>

  <div class="text-center mt-3 text-muted">or sign in with</div>

  <div class="social-icons">
    <div class="social-icon"><img src="{{url_for('static',filename='assets/images/brands/10.png')}}" width="28"></div>
    <div class="social-icon"><img src="{{url_for('static',filename='assets/images/brands/08.png')}}" width="28"></div>
    <div class="social-icon"><img src="{{url_for('static',filename='assets/images/brands/13.png')}}" width="28"></div>
  </div>

  <div class="text-center mt-4 signin-link">
    <small>Don't have an account?
      <a href="{{url_for('auth.register')}}" class="text-decoration-none">Click here to sign up</a>
    </small>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Login function
    function login() {
      const data = {
        email: document.getElementById("email").value,
        password: document.getElementById("password").value,
        captcha: document.getElementById("captcha").value
      };

      fetch("/auth/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      })
        .then(res => res.json())
        .then(res => {
          alert(res.message);
          if (res.success) {
            // ✅ Redirect to backend-specified dashboard
            setTimeout(() => window.location.href = res.redirect, 500);
          } else {
            refreshCaptcha();
          }
        })
        .catch(err => {
          console.error("Login error:", err);
          alert("Something went wrong, please try again.");
        });
    }

    // Refresh captcha
    function refreshCaptcha() {
      fetch("/auth/captcha")
        .then(res => res.json())
        .then(data => {
          document.getElementById("captcha-text").innerText = data.captcha;
        });
    }

    // Attach refresh button
    const refreshBtn = document.getElementById("refreshBtn");
    if (refreshBtn) {
      refreshBtn.addEventListener("click", refreshCaptcha);
    }

    // Password toggle
    const toggleBtn = document.getElementById("togglePassword");
    if (toggleBtn) {
      toggleBtn.addEventListener("click", function () {
        const password = document.getElementById("password");
        const icon = this.querySelector("i");

        if (password.type === "password") {
          password.type = "text";
          icon.classList.replace("fa-eye", "fa-eye-slash");
        } else {
          password.type = "password";
          icon.classList.replace("fa-eye-slash", "fa-eye");
        }
      });
    }

    // Form submission
    const form = document.getElementById("loginForm");
    if (form) {
      form.addEventListener("submit", function (e) {
        e.preventDefault();
        login();
      });
    }
  });
</script>
{% endblock %}
