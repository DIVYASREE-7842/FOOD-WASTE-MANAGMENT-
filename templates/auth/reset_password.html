{% extends "base.html" %}

{% block title %}Reset Password{% endblock %}

{% block content %}
<div class="container d-flex justify-content-center align-items-center mt-5">
    <div class="card shadow-lg border-0 p-4" style="width: 28rem; border-radius: 1rem;">
        <div class="card-body">
            <h3 class="card-title text-center mb-4">Reset Password</h3>
            
           <form id="resetPasswordForm" action="{{ url_for('auth.reset_password', token=token) }}" method="POST">

                <div class="mb-3">
                    <label class="form-label fw-bold">New Password</label>
                    <div class="input-group">
                        <input type="password" id="password" name="password" class="form-control" placeholder="Enter new password" required>
                        <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                            <i class="fa fa-eye"></i>
                        </button>
                    </div>
                    <div class="text-danger small mt-1" id="passwordError"></div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Confirm Password</label>
                    <input type="password" id="confirmPassword" name="confirm_password" class="form-control" placeholder="Confirm new password" required>
                    <div class="text-danger small mt-1" id="confirmPasswordError"></div>
                </div>
                
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                        <span id="submitText">Reset Password</span>
                        <div id="loadingSpinner" class="spinner-border spinner-border-sm d-none" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </button>
                </div>
            </form>

            <div class="text-center mt-3">
                <a href="{{ url_for('auth.login_page') }}" class="text-decoration-none">Back to Login</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Password toggle functionality
    document.getElementById("togglePassword").addEventListener("click", function() {
        const password = document.getElementById("password");
        const type = password.getAttribute("type") === "password" ? "text" : "password";
        password.setAttribute("type", type);
        
        const icon = this.querySelector("i");
        if (icon) {
            icon.classList.toggle("fa-eye");
            icon.classList.toggle("fa-eye-slash");
        }
    });

    // Form submission handling
    document.getElementById("resetPasswordForm").addEventListener("submit", function(e) {
        e.preventDefault();
        
        const password = document.getElementById("password").value;
        const confirmPassword = document.getElementById("confirmPassword").value;
        const passwordError = document.getElementById("passwordError");
        const confirmPasswordError = document.getElementById("confirmPasswordError");
        const submitBtn = document.getElementById("submitBtn");
        const submitText = document.getElementById("submitText");
        const loadingSpinner = document.getElementById("loadingSpinner");
        
        // Reset errors
        passwordError.textContent = "";
        confirmPasswordError.textContent = "";
        
        // Validation
        let isValid = true;
        
        if (password.length < 6) {
            passwordError.textContent = "Password must be at least 6 characters";
            isValid = false;
        }
        
        if (password !== confirmPassword) {
            confirmPasswordError.textContent = "Passwords do not match";
            isValid = false;
        }
        
        if (!isValid) return;
        
        // Show loading state
        submitBtn.disabled = true;
        submitText.classList.add("d-none");
        loadingSpinner.classList.remove("d-none");
        
        // Submit form via AJAX
        fetch("{{ url_for('auth.reset_password', token=token) }}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
            },
            body: new URLSearchParams({
                password: password,
                confirm_password: confirmPassword
            })
        })
        .then(response => response.text())
        .then(html => {
            // Create temporary element to parse flash messages
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            // Check for flash messages
            const alerts = tempDiv.querySelectorAll('.alert');
            if (alerts.length > 0) {
                // Show flash messages
                const flashContainer = document.querySelector('.container.mt-3');
                if (flashContainer) {
                    flashContainer.innerHTML = '';
                    alerts.forEach(alert => {
                        flashContainer.appendChild(alert.cloneNode(true));
                    });
                    
                    // Scroll to top to show messages
                    window.scrollTo(0, 0);
                }
                
                // If success, redirect after delay
                if (tempDiv.querySelector('.alert-success')) {
                    setTimeout(() => {
                        window.location.href = "{{ url_for('auth.login_page') }}";
                    }, 2000);
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        })
        .finally(() => {
            // Reset loading state
            submitBtn.disabled = false;
            submitText.classList.remove("d-none");
            loadingSpinner.classList.add("d-none");
        });
    });
</script>
{% endblock %}