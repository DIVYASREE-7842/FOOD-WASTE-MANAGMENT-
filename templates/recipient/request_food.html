{% extends "base.html" %}
{% block title %}Request Food{% endblock %}

{% block content %}
<style>
  /* Request Food Form CSS */
  :root {
    --primary-color: #ee9d4d7c;
    --secondary-color: #fcac68;
    --dark-color: #2c3e50;
    --light-color: #f4f7fa;
    --text-dark: #333;
    --text-medium: #555;
    --text-light: #818999;
    --transition-speed: 0.4s;
  }

  /* Reset and base styles */

  .container {
    max-width: 1000px;
    margin: 0 auto;
  }

  /* Animation */
  .animate__animated {
    animation-duration: 0.8s;
  }

  .animate__fadeIn {
    animation-name: fadeIn;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Card styling */
  .card {
    border: none;
    border-radius: 15px;
    overflow: hidden;
    transition: transform var(--transition-speed), box-shadow var(--transition-speed);
  }

  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15) !important;
  }

  .card-header {
    background: linear-gradient(135deg, var(--secondary-color), var(--primary-color)) !important;
    border: none;
    padding: 1.5rem;
  }

  .card-header h3 {
    font-weight: 700;
    font-size: 1.8rem;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
    color: var(--dark-color);
  }

  .card-body {
    padding: 2rem;
  }

  /* Form styling */
  form {
    color: var(--text-dark);
  }

  .form-label {
    color: var(--dark-color);
    font-weight: 600;
    margin-bottom: 0.5rem;
    display: block;
  }

  .form-control,
  .form-select {
    border: 1px solid #dce1e6;
    border-radius: 10px;
    padding: 0.75rem 1rem;
    transition: all var(--transition-speed);
    color: var(--text-dark);
    font-size: 1rem;
  }

  .form-control:focus,
  .form-select:focus {
    border-color: var(--secondary-color);
    box-shadow: 0 0 0 0.25rem rgba(40, 167, 69, 0.25);
    outline: none;
  }

  .form-control::placeholder {
    color: var(--text-light);
  }

  textarea.form-control {
    resize: vertical;
    min-height: 100px;
  }

  /* Button styling */
  .btn {
    padding: 0.7rem 1.5rem;
    font-size: 1rem;
    font-weight: 600;
    border-radius: 10px;
    transition: all var(--transition-speed);
    border: none;
    margin: 0 0.5rem;
  }

  .btn-success {
    background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
    box-shadow: 0 4px 8px rgba(167, 99, 40, 0.3);
    color: white;
  }

  .btn-success:hover {
    background: linear-gradient(135deg, orange, var(--secondary-color));
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(167, 97, 40, 0.4);
    color: white;
  }

  .btn-secondary {
    background: var(--light-color);
    color: var(--text-dark);
    border: 2px solid var(--text-light);
  }

  .btn-secondary:hover {
    background: var(--text-light);
    color: white;
    border-color: var(--text-light);
    transform: translateY(-2px);
  }

  .btn-outline-primary {
    background: transparent;
    color: var(--secondary-color);
    border: 2px solid var(--seconadry-color);
    padding: 0.6rem 1.2rem;
  }

  .btn-outline-primary:hover {
    background: var(--primary-color);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(167, 80, 40, 0.3);
  }

  /* Location button styling */
  #useLocation {
    font-size: 1.1rem;
    padding: 0.8rem 1.5rem;
    border-radius: 50px;
    transition: all var(--transition-speed);
  }

  #useLocation:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 15px rgba(167, 82, 40, 0.3);
  }

  /* Row and column adjustments */
  .row.align-items-end {
    margin: 0 -0.5rem;
  }

  .col-md-4 {
    padding: 0 0.5rem;
  }

  /* Text center */
  .text-center {
    margin-top: 1.5rem;
  }

  /* Hidden inputs */
  input[type="hidden"] {
    display: none;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .card-body {
      padding: 1.5rem;
    }

    .row.align-items-end {
      margin: 0;
    }

    .col-md-4 {
      margin-bottom: 1rem;
      padding: 0;
    }

    .btn {
      margin-bottom: 0.5rem;
      width: 100%;
    }
  }

  @media (max-width: 576px) {
    body {
      padding: 10px;
    }

    .card-body {
      padding: 1rem;
    }

    .card-header h3 {
      font-size: 1.5rem;
    }

    .form-control,
    .form-select {
      padding: 0.6rem 0.8rem;
    }

    #useLocation {
      font-size: 1rem;
      padding: 0.6rem 1rem;
    }
  }

  /* Focus states for accessibility */
  .form-control:focus,
  .form-select:focus,
  .btn:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(167, 87, 40, 0.3);
  }

  /* Animation for form elements */
  .form-control,
  .form-select,
  .btn {
    transition: all var(--transition-speed);
  }

  /* Success color theme throughout */
  .card-header,
  .btn-success,
  .btn-outline-primary:hover {
    background: linear-gradient(135deg, var(--secondary-color), #ce6c34);
  }

  /* Custom styles for select dropdowns */
  .form-select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 16px 12px;
  }
</style>
<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-lg animate__animated animate__fadeIn">
        <div class="card-header bg-success text-white text-center">
          <h3 class="mb-0">Request Food</h3>
        </div>
        <div class="card-body">
          <form method="POST">

            <!-- Food Type -->
            <!-- Food Type -->
            <!-- Food Type -->
            <div class="mb-3">
              <label class="form-label">Food Type</label>
              <input type="text" name="food_type" class="form-control"
                value="{{ request.form.get('food_type', donation.food_type if donation else '') }}">
            </div>

            <!-- Quantity -->
            <div class="mb-3">
              <label class="form-label">Quantity</label>
              <input type="text" name="quantity" class="form-control"
                value="{{ request.form.get('quantity', donation.quantity if donation else '') }}">
            </div>

            <!-- Food -->
            <div class="mb-3">
              <label class="form-label">Food</label>
              <input type="text" name="food" class="form-control"
                value="{{ request.form.get('food', donation.food if donation else '') }}">
            </div>

            <!-- Address -->
            <div class="mb-3">
              <label class="form-label">Delivery Address</label>
              <textarea name="address" id="address" class="form-control" rows="3"
                required>{{ request.form.get('address', donation.address if donation else recipient.address) }}</textarea>
            </div>


            <!-- Location Selection -->
            <div class="row align-items-end">
              <div class="col-md-4 mb-3">
                <label class="form-label">Country</label>
                <select name="country_code" id="country" class="form-select"></select>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">State</label>
                <select name="state_code" id="state" class="form-select" required></select>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">City</label>
                <select name="city_id" id="city" class="form-select" required></select>
              </div>
            </div>

            <!-- Use My Location Button -->
            <div class="mb-3 text-center">
              <button type="button" id="useLocation" class="btn btn-outline-primary">
                üìç Use My Current Location
              </button>
            </div>

            <!-- Hidden fields for lat/long -->
            <input type="hidden" name="latitude" id="latitude">
            <input type="hidden" name="longitude" id="longitude">

            <!-- Submit -->
            <div class="text-center">
              <button type="submit" class="btn btn-success px-4">Submit Request</button>
              <a href="{{ url_for('recipient.available_donations') }}" class="btn btn-secondary px-4">Cancel</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
// ===============================
  // Country / State / City Dropdowns
  // ===============================
  async function loadCountries() {
    const countrySelect = document.getElementById('country');
    const stateSelect = document.getElementById('state');
    const citySelect = document.getElementById('city');

    if (!countrySelect) return;
    try {
      const response = await fetch('/auth/api/countries');
      const countries = await response.json();
      countrySelect.innerHTML = '<option value="">Select Country</option>';
      countries.forEach(c => {
        const option = document.createElement('option');
        option.value = c.iso2;
        option.textContent = c.name;
        countrySelect.appendChild(option);
      });
      countrySelect.disabled = false;
    } catch (error) {
      console.error('Error loading countries:', error);
    }
  }

  async function loadStates(countryCode) {
    const stateSelect = document.getElementById('state');
    const citySelect = document.getElementById('city');
    if (!stateSelect || !countryCode) return;

    try {
      const response = await fetch(`/auth/api/countries/${countryCode}/states`);
      const states = await response.json();
      stateSelect.innerHTML = '<option value="">Select State</option>';
      states.forEach(s => {
        const option = document.createElement('option');
        option.value = s.iso2;
        option.textContent = s.name;
        stateSelect.appendChild(option);
      });
      stateSelect.disabled = false;
      if (citySelect) citySelect.disabled = true;
    } catch (error) {
      console.error('Error loading states:', error);
    }
  }

  async function loadCities(countryCode, stateCode) {
    const citySelect = document.getElementById('city');
    if (!citySelect || !countryCode || !stateCode) return;

    try {
      const response = await fetch(`/auth/api/countries/${countryCode}/states/${stateCode}/cities`);
      const cities = await response.json();
      citySelect.innerHTML = '<option value="">Select City</option>';
      cities.forEach(c => {
        const option = document.createElement('option');
        option.value = c.id;
        option.textContent = c.name;
        citySelect.appendChild(option);
      });
      citySelect.disabled = false;
    } catch (error) {
      console.error('Error loading cities:', error);
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    loadCountries();
    const countrySelect = document.getElementById('country');
    const stateSelect = document.getElementById('state');

    countrySelect?.addEventListener('change', function () {
      loadStates(this.value);
    });
    stateSelect?.addEventListener('change', function () {
      const countryVal = countrySelect.value;
      if (countryVal) loadCities(countryVal, this.value);
    });
  });
</script>

</script>
<script>
     // Use my current location
    document.getElementById("useLocation").addEventListener("click", () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(successLocation, errorLocation, { enableHighAccuracy: true });
      } else {
        alert("Geolocation not supported by your browser.");
      }
    });

    function successLocation(position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;

      document.getElementById("latitude").value = lat;
      document.getElementById("longitude").value = lon;

      // Optional: Reverse geocode to fill address field
      fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&zoom=18&addressdetails=1`)
        .then(res => res.json())
        .then(data => {
          if (data && data.address) {
            const addr = data.address;
            let fullAddr = '';
            if (addr.road) fullAddr += addr.road + ', ';
            if (addr.suburb) fullAddr += addr.suburb + ', ';
            if (addr.village) fullAddr += addr.village + ', ';
            else if (addr.town) fullAddr += addr.town + ', ';
            else if (addr.city) fullAddr += addr.city + ', ';
            if (addr.state) fullAddr += addr.state + ', ';
            if (addr.country) fullAddr += addr.country;

            addressField.value = fullAddr;
          }
        })
        .catch(err => console.error("Reverse geocoding error:", err));
    }

    function errorLocation(err) {
      alert("Unable to get your location. Please allow location access.");
      console.warn(`ERROR(${err.code}): ${err.message}`);
    }
  
</script>
{% endblock %}