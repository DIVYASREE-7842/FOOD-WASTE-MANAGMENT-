{% extends "base.html" %}
{% block title %}Recipient Details{% endblock %}

{% block content %}
<style>
:root {
  --primary-color: #ee9d4d7c;
  --secondary-color: #fcac68;
  --dark-color: #2c3e50;
  --light-color: #f4f7fa;
  --text-dark: #333;
  --text-medium: #555;
  --text-light: #818999;
  --transition-speed: 0.4s;
}

body {
  background-color: var(--light-color);
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.back-btn {
  background-color: var(--secondary-color);
  border: none;
  color: var(--dark-color);
  font-weight: 500;
  padding: 0.5rem 1rem;
  transition: all var(--transition-speed);
}

.back-btn:hover {
  background-color: var(--primary-color);
  transform: translateX(-3px);
}

.header-card {
  background: linear-gradient(135deg, #ffffff 0%, var(--light-color) 100%);
  border-left: 5px solid var(--secondary-color);
  box-shadow: 0 5px 15px rgba(0,0,0,0.08);
  border-radius: 10px;
}

.recipient-name {
  color: var(--dark-color);
  font-weight: 700;
  margin-bottom: 1rem;
}

.recipient-details p {
  margin-bottom: 0.7rem;
  color: var(--text-medium);
}

.type-badge {
  background-color: var(--primary-color);
  color: var(--dark-color);
  font-weight: 500;
  padding: 0.3rem 0.7rem;
  border-radius: 4px;
}

.rating-value {
  font-weight: 600;
  color: var(--secondary-color);
  margin-right: 0.5rem;
}

.rating-stars {
  color: var(--secondary-color);
}

.stats-card {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
  border-radius: 10px;
  padding: 1.5rem;
  color: var(--dark-color);
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  text-align: center;
}

.stat-value {
  font-size: 2.5rem;
  font-weight: 700;
  line-height: 1;
}

.stat-label {
  font-size: 0.9rem;
  opacity: 0.9;
  margin-top: 0.5rem;
}

.profile-card {
  background: white;
  border-radius: 10px;
  padding: 1.5rem;
  text-align: center;
  box-shadow: 0 3px 10px rgba(0,0,0,0.08);
  height: 100%;
}

.profile-card img {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  object-fit: cover;
  border: 4px solid var(--primary-color);
  margin-bottom: 1rem;
}

.profile-name {
  color: var(--dark-color);
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.profile-email {
  color: var(--text-medium);
  margin-bottom: 1rem;
}

.analytics-card {
  border: none;
  border-radius: 10px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.08);
  transition: transform var(--transition-speed);
  height: 100%;
  margin-bottom: 1.5rem;
}

.analytics-card:hover {
  transform: translateY(-3px);
}

.analytics-card .card-body {
  padding: 1.5rem;
}

.analytics-card h5 {
  color: var(--dark-color);
  font-weight: 600;
  margin-bottom: 1rem;
}

.chart-container {
  height: 250px;
  position: relative;
}

.map-card {
  border: none;
  border-radius: 10px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.08);
}

.map-card .card-body {
  padding: 1.5rem;
}

.map-card h5 {
  color: var(--dark-color);
  font-weight: 600;
  margin-bottom: 1rem;
}

#map {
  height: 400px;
  border-radius: 8px;
  overflow: hidden;
}

.no-location {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--text-light);
}

.no-location i {
  font-size: 3rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}

.status-badge {
  background-color: var(--secondary-color);
  color: var(--dark-color);
  padding: 0.3rem 0.8rem;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 500;
}

@media (max-width: 768px) {
  .stat-value {
    font-size: 2rem;
  }
  
  .chart-container {
    height: 200px;
  }
  
  #map {
    height: 300px;
  }
}
</style>

<div class="container-fluid mt-4">
  <a href="{{ url_for('admin.recipients') }}" class="btn back-btn mb-4">
    <i class="fas fa-arrow-left"></i> Back to Recipients
  </a>

  <!-- Profile Header Section -->
  <div class="row mb-4">
    <!-- Profile Card -->
    <div class="col-md-4 mb-4">
      <div class="profile-card">
        {% if recipient.user_profile %}
          <img src="{{ url_for('static', filename='uploads/' ~ recipient.user_profile) }}" 
               alt="{{ recipient.first_name }} {{ recipient.last_name }}">
        {% else %}
          <img src="{{ url_for('static', filename='images/default.png') }}" 
               alt="Default Profile">
        {% endif %}
        <h4 class="profile-name">{{ recipient.first_name }} {{ recipient.last_name }}</h4>
        <p class="profile-email">{{ recipient.email }}</p>
        
        <div class="recipient-details text-start">
          <p><strong>Organization:</strong> {{ recipient.org_name or "N/A" }}</p>
          <p><strong>Type:</strong> <span class="type-badge">{{ recipient.org_type }}</span></p>
          <p><strong>License:</strong> {{ recipient.licience or "N/A" }}</p>
          <p><strong>Status:</strong> <span class="status-badge">{{ recipient.status }}</span></p>
        </div>
      </div>
    </div>

    <!-- Details Card -->
    <div class="col-md-8">
      <div class="card header-card h-100">
        <div class="card-body">
          <div class="row h-100">
            <div class="col-md-8">
              <h3 class="recipient-name">
                {{ recipient.org_name or (recipient.first_name ~ ' ' ~ recipient.last_name) }}
              </h3>
              <div class="recipient-details">
                <p><strong>Description:</strong> {{ recipient.description or "No description provided" }}</p>
                <p>
                  <strong>Avg Rating:</strong> 
                  <span class="rating-value">{{ recipient.avg_rating or 0 }}/5</span>
                  <span class="rating-stars">
                    {% for i in range(5) %}
                      {% if i < (recipient.avg_rating or 0)|int %}
                        <i class="fas fa-star"></i>
                      {% else %}
                        <i class="far fa-star"></i>
                      {% endif %}
                    {% endfor %}
                  </span>
                </p>
                <p><strong>Address:</strong> {{ recipient.address or 'N/A' }}</p>
              </div>
            </div>
            <div class="col-md-4 d-flex align-items-center justify-content-center">
              <div class="stats-card">
                <div class="stat-value">{{ request_counts|sum if request_counts else 0 }}</div>
                <div class="stat-label">Total Requests</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Analytics Section -->
  <div class="row">
    <div class="col-md-4">
      <div class="card analytics-card">
        <div class="card-body">
          <h5>Requests Timeline</h5>
          <div class="chart-container">
            <canvas id="timelineChart"></canvas>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="card analytics-card">
        <div class="card-body">
          <h5>Requests by Status</h5>
          <div class="chart-container">
            <canvas id="statusChart"></canvas>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="card analytics-card">
        <div class="card-body">
          <h5>Requests by Food Type</h5>
          <div class="chart-container">
            <canvas id="foodChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Map Section -->
  <div class="card map-card mt-4">
    <div class="card-body">
      <h5>Recipient Location</h5>
      <div id="map"></div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// Color palette matching your theme
const chartColors = [
  '#ee9d4d', '#fcac68', '#2c3e50', '#4A90E2', 
  '#50E3C2', '#F5A623', '#D0021B', '#7ED321'
];

// Timeline Chart
const timelineLabels = {{ request_labels|tojson }};
const timelineCounts = {{ request_counts|tojson }};
if (timelineLabels && timelineCounts) {
  new Chart(document.getElementById('timelineChart'), {
    type: 'line',
    data: {
      labels: timelineLabels,
      datasets: [{
        label: 'Requests',
        data: timelineCounts,
        borderColor: chartColors[0],
        backgroundColor: chartColors[0] + '20',
        borderWidth: 3,
        tension: 0.3,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      }
    }
  });
}

// Status Chart
const statusLabels = {{ status_labels|tojson }};
const statusCounts = {{ status_counts|tojson }};
if (statusLabels && statusCounts) {
  new Chart(document.getElementById('statusChart'), {
    type: 'doughnut',
    data: {
      labels: statusLabels,
      datasets: [{
        data: statusCounts,
        backgroundColor: [chartColors[3], chartColors[5], chartColors[6], chartColors[4]]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });
}

// Food Type Chart
const foodLabels = {{ food_labels|tojson }};
const foodCounts = {{ food_counts|tojson }};
if (foodLabels && foodCounts) {
  new Chart(document.getElementById('foodChart'), {
    type: 'pie',
    data: {
      labels: foodLabels,
      datasets: [{
        data: foodCounts,
        backgroundColor: chartColors.slice(0, foodLabels.length)
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });
}

// Leaflet Map
const lat = {{ recipient.latitude or "null" }};
const lng = {{ recipient.longitude or "null" }};
if (lat && lng) {
  var map = L.map('map').setView([lat, lng], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
  }).addTo(map);

  L.marker([lat, lng]).addTo(map)
    .bindPopup("<b>{{ recipient.org_name or recipient.first_name ~ ' ' ~ recipient.last_name }}</b><br>{{ recipient.address }}")
    .openPopup();
} else {
  document.getElementById("map").innerHTML = 
    '<div class="no-location"><i class="fas fa-map-marker-alt"></i><p>No location available</p></div>';
}
</script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    var donorLat = {{ recipient.latitude or 0 }};
    var donorLng = {{ recipient.longitude or 0 }};
    var donorAddress = {{ recipient.address|tojson }};

    var map = L.map('map').setView([recipientLat, recipientLng], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    L.marker([recipientLat, recipientLng])
      .addTo(map)
      .bindPopup("<b>" + {{ recipient.org_name|tojson }} + "</b><br>" + donorAddress)
      .openPopup();

    setTimeout(function() { map.invalidateSize(); }, 100);
});
</script>

{% endblock %}